generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id              String    @id @default(uuid())
  email           String    @unique
  password        String
  name            String
  cpf             String    @unique
  course String?
  discount String?
  instituition String?
  customerId      String    @unique
  birthDate       DateTime?
  createdAt       DateTime  @default(now())
  currentPayment  Boolean   @default(false)
  firstPayment Boolean @default(false)
  renovacao Int? @default(0)
  phone           String
  tokenExpiration String?
  token           String?
  addresses Address[]
  contracts       Contract[]
  contractSignatures ContractSignature[]
}

model Address {
  id           String  @id @default(uuid())
  street       String
  number       String
  complement   String?
  neighborhood String
  uf           String
  city         String
  cep          String
  userId       String
  address User @relation(fields: [userId], references: [id])

  @@index([userId], map: "Address_userId_fkey")
}

model Contract {
  id            String   @id @default(uuid())
  userId        String
  title         String
  version       Int      @default(1)

  // Status do fluxo
  status        ContractStatus @default(DRAFT)

  // PDF original (que você já gera)
  pdfUrl        String
  pdfHash       String?  // sha256 do PDF original (calculado no server)

  // PDF final (contrato + evidências)
  signedPdfUrl  String?
  signedPdfHash String?
  signedAt      DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [userId], references: [id])
  signatures    ContractSignature[]
  events        ContractEvent[]

  @@index([userId])
}

model ContractSignature {
  id          String   @id @default(uuid())
  contractId  String
  userId      String

  // Identificador único do “evento de assinatura”
  evidenceId  String   @unique

  signedAt    DateTime @default(now())

  ip          String?
  userAgent   String?

  // Texto do aceite (checkbox)
  consentText String

  // Evidências extras (json)
  evidence    Json

  // hashes (integridade)
  originalPdfHash String
  signedPdfHash   String

  contract    Contract @relation(fields: [contractId], references: [id])
  user        User     @relation(fields: [userId], references: [id])

  @@index([contractId])
  @@index([userId])
}

model ContractEvent {
  id         String   @id @default(uuid())
  contractId String
  type       ContractEventType
  metadata   Json
  createdAt  DateTime @default(now())

  contract   Contract @relation(fields: [contractId], references: [id])

  @@index([contractId])
}

enum ContractStatus {
  DRAFT
  SENT
  SIGNED
  REFUSED
  EXPIRED
}

enum ContractEventType {
  VIEWED
  CONSENTED
  SIGNED
  REFUSED
}